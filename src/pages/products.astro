---
import { getImage } from "astro:assets";
import BaseLayout from "../layouts/BaseLayout.astro";
import Card from "../components/Card.svelte";
import { products } from "../data/products";

const images = import.meta.glob<{ default: ImageMetadata }>("/src/images/*.*", { eager: true });

const productsWithOptimizedImages = await Promise.all(
	products.map(async (product) => {
		if (!product.bannerImage) return product;
		const imageModule = images[`/src/images/${product.bannerImage}`];
		const [full, thumbnail] = await Promise.all([
			getImage({ src: imageModule.default, format: "webp" }),
			getImage({ src: imageModule.default, format: "webp", width: 800 })
		]);
		return { ...product, bannerImage: full.src, thumbnailImage: thumbnail.src };
	})
);

const preloadUrls = productsWithOptimizedImages
	.filter(p => p.bannerImage)
	.map(p => p.bannerImage as string);
---
<BaseLayout headerText="Products">
	<section class="products-grid">
		{productsWithOptimizedImages.map((product) =>
    <Card client:visible item={product} bannerRatio={33.3} modalWidth={70} modalHeight={80} />
		)}
	</section>
	<script define:vars={{ preloadUrls }}>
		window.addEventListener('load', () => {
			preloadUrls.forEach(url => { new Image().src = url; });
		});
	</script>
</BaseLayout>

<style>
	.products-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(320px, 420px));
		justify-content: center;
		gap: 5rem;
		padding: 4rem 2rem;
	}
</style>
